include(AwsTestHarness)
enable_testing()

option(ENABLE_S3_NET_TESTS "Run S3 tests requiring internet connection and credentials" OFF)
option(ENABLE_S3_PERFORMANCE_TESTS "Run S3 performance tests" OFF)
option(PERFORMANCE_TEST_LOGGING "Whether performance tests should log output" OFF)
option(PERFORMANCE_TEST_VALIDATE_PUTS, "Whether put operations should be validated during performance tests" OFF)

set(S3_TEST_BUCKET "aws-crt-canary-bucket-eu-west-1" CACHE STRING "Name of the bucket to use for tests" )
set(S3_TEST_REGION "eu-west-1" CACHE STRING "Name of the region to use for tests")
set(PERFORMANCE_TEST_THROUGHPUT_TARGET_GBPS "100.0" CACHE STRING "Throughput target for performance tests")
set(PERFORMANCE_TEST_NUM_TRANSFERS "1600" CACHE STRING "Number of transfers to do during performance tests")
set(PERFORMANCE_TEST_UPLOAD_OBJECT_SIZE_MB "5120" CACHE STRING "Size of the object in megabytes to upload during performance tests")

add_definitions(-DS3_TEST_BUCKET="${S3_TEST_BUCKET}")
add_definitions(-DS3_TEST_REGION="${S3_TEST_REGION}")
add_definitions(-DPERFORMANCE_TEST_THROUGHPUT_TARGET_GBPS=${PERFORMANCE_TEST_THROUGHPUT_TARGET_GBPS})
add_definitions(-DPERFORMANCE_TEST_NUM_TRANSFERS=${PERFORMANCE_TEST_NUM_TRANSFERS})
add_definitions(-DPERFORMANCE_TEST_UPLOAD_OBJECT_SIZE_MB=${PERFORMANCE_TEST_UPLOAD_OBJECT_SIZE_MB})

if(PERFORMANCE_TEST_VALIDATE_PUTS)
    add_definitions(-DPERFORMANCE_TEST_VALIDATE_PUTS)
endif()

if(PERFORMANCE_TEST_LOGGING)
    add_definitions(-DPERFORMANCE_TEST_LOGGING_ENABLED)
endif()

macro(add_s3_net_test_case name)
    if (ENABLE_S3_NET_TESTS)
        list(APPEND TEST_CASES "${name}")
        list(APPEND AWS_TEST_CASES "${name}")
        set_property(GLOBAL PROPERTY AWS_TEST_CASES ${AWS_TEST_CASES})
    endif()
endmacro()

file(GLOB TEST_SRC "*.c")
file(GLOB TEST_HDRS "*.h")
file(GLOB TESTS ${TEST_HDRS} ${TEST_SRC})

add_test_case(test_s3_copy_http_message)
add_test_case(test_s3_message_util_assign_body)
add_test_case(test_s3_get_object_message_new)
add_test_case(test_s3_set_multipart_request_path)
add_test_case(test_s3_create_multipart_upload_message_new)
add_test_case(test_s3_upload_part_message_new)
add_test_case(test_s3_complete_multipart_message_new)
add_test_case(test_s3_abort_multipart_upload_message_new)

add_s3_net_test_case(test_s3_client_create_destroy)
add_s3_net_test_case(test_s3_client_max_active_connections_override)
add_test_case(test_s3_client_get_max_active_connections)
add_test_case(test_s3_request_create_destroy)
add_test_case(test_s3_client_queue_requests)
add_test_case(test_s3_meta_request_body_streaming)
add_test_case(test_s3_update_meta_requests_no_endpoint_conns)
add_test_case(test_s3_update_meta_requests_no_conns_yet)
add_test_case(test_s3_update_meta_requests_trigger_prepare)
add_test_case(test_s3_client_update_connections_request_assign)
add_test_case(test_s3_client_update_connections_too_many_conns)
add_test_case(test_s3_client_update_connections_finish_result)
add_test_case(test_s3_client_update_connections_clean_up)

add_net_test_case(test_s3_vip_create_destroy)
add_net_test_case(test_s3_client_add_remove_vips)
add_net_test_case(test_s3_client_resolve_vips)
add_test_case(test_s3_client_set_vip_connection_warm)
add_test_case(test_s3_client_set_vip_connection_active)

add_s3_net_test_case(test_s3_client_exceed_retries)
add_s3_net_test_case(test_s3_client_acquire_connection_fail)
add_s3_net_test_case(test_s3_meta_request_fail_prepare_request)
add_s3_net_test_case(test_s3_meta_request_sign_request_fail)
add_s3_net_test_case(test_s3_meta_request_send_request_finish_fail)
add_s3_net_test_case(test_s3_auto_range_put_missing_upload_id)

add_s3_net_test_case(test_s3_cancel_mpu_create_not_sent)
add_s3_net_test_case(test_s3_cancel_mpu_create_completed)
add_s3_net_test_case(test_s3_cancel_mpu_one_part_completed)
add_s3_net_test_case(test_s3_cancel_mpu_all_parts_completed)
add_s3_net_test_case(test_s3_cancel_mpd_nothing_sent)
add_s3_net_test_case(test_s3_cancel_mpd_one_part_sent)

add_s3_net_test_case(test_s3_get_object_tls_disabled)
add_s3_net_test_case(test_s3_get_object_tls_enabled)
add_s3_net_test_case(test_s3_get_object_tls_default)
add_s3_net_test_case(test_s3_get_object_less_than_part_size)
add_s3_net_test_case(test_s3_get_object_empty_object)
add_s3_net_test_case(test_s3_get_object_multiple)
add_s3_net_test_case(test_s3_get_object_sse_kms)
add_s3_net_test_case(test_s3_get_object_sse_aes256)
add_s3_net_test_case(test_s3_no_signing)
add_s3_net_test_case(test_s3_signing_override)
add_s3_net_test_case(test_s3_put_object_tls_disabled)
add_s3_net_test_case(test_s3_put_object_tls_enabled)
add_s3_net_test_case(test_s3_put_object_tls_default)
add_s3_net_test_case(test_s3_multipart_put_object_with_acl)
add_s3_net_test_case(test_s3_put_object_multiple)
add_s3_net_test_case(test_s3_put_object_less_than_part_size)
add_s3_net_test_case(test_s3_put_object_empty_object)
add_s3_net_test_case(test_s3_put_object_with_part_remainder)
add_s3_net_test_case(test_s3_put_object_sse_kms)
add_s3_net_test_case(test_s3_put_object_sse_kms_multipart)
add_s3_net_test_case(test_s3_put_object_sse_aes256)
add_s3_net_test_case(test_s3_put_object_sse_aes256_multipart)
add_s3_net_test_case(test_s3_meta_request_default)
add_s3_net_test_case(test_s3_put_object_fail_headers_callback)
add_s3_net_test_case(test_s3_put_object_fail_body_callback)
add_s3_net_test_case(test_s3_get_object_fail_headers_callback)
add_s3_net_test_case(test_s3_get_object_fail_body_callback)
add_s3_net_test_case(test_s3_default_fail_headers_callback)
add_s3_net_test_case(test_s3_default_fail_body_callback)
add_s3_net_test_case(test_s3_error_missing_file)
add_s3_net_test_case(test_s3_existing_host_entry)
add_s3_net_test_case(test_s3_put_fail_object_invalid_request)
add_s3_net_test_case(test_s3_put_fail_object_inputstream_fail_reading)
add_s3_net_test_case(test_s3_put_single_part_fail_object_inputstream_fail_reading)
add_s3_net_test_case(test_s3_bad_endpoint)
add_s3_net_test_case(test_s3_put_object_clamp_part_size)

add_test_case(test_add_user_agent_header)
add_s3_net_test_case(test_s3_auto_ranged_get_sending_user_agent)
add_s3_net_test_case(test_s3_auto_ranged_put_sending_user_agent)
add_s3_net_test_case(test_s3_default_sending_user_agent)

add_test_case(test_s3_replace_quote_entities)
add_s3_net_test_case(test_s3_different_endpoints)

add_test_case(test_get_existing_compute_platform_info)
add_test_case(test_get_nonexistent_compute_platform_info)

if(ENABLE_S3_PERFORMANCE_TESTS)
    add_s3_net_test_case(test_s3_get_performance)
    add_s3_net_test_case(test_s3_put_performance)
endif()

set(TEST_BINARY_NAME ${PROJECT_NAME}-tests)
generate_test_driver(${TEST_BINARY_NAME})
